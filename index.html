<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Genetic Construct Designer</title>
    <style>
        :root {
            /* Lox Colors (for outlines) */
            --lox1: #0072B2; --lox2: #E69F00; --lox3: #56B4E9; 
            --lox4: #F0E442; --lox5: #D55E00; --lox6: #009E73;
            /* ORF Colors (for solid fills) */
            --orf1: #CC79A7; --orf2: #9b59b6; --orf3: #e74c3c; --orf4: #2ecc71;
            --stop: #000000; --t2a: #999999; --pa: #555555;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        .piece-wrapper { position: relative; padding: 10px 4px; cursor: grab; display: flex; align-items: center; }
        .dna-block { 
            height: 40px; min-width: 90px; padding: 0 12px; color: white; 
            font-weight: bold; display: flex; align-items: center; justify-content: center; 
            font-size: 11px; user-select: none; box-sizing: border-box;
            clip-path: polygon(0% 0%, 85% 0%, 100% 50%, 85% 100%, 0% 100%);
        }
        .piece-wrapper.rev .dna-block { clip-path: polygon(15% 0%, 100% 0%, 100% 100%, 15% 100%, 0% 50%); }

        /* Hollow Lox Styling */
        .lox-style { background: transparent; border: 3px solid; color: #333 !important; }
        .lox1 { border-color: var(--lox1); color: var(--lox1) !important; }
        .lox2 { border-color: var(--lox2); color: var(--lox2) !important; }
        .lox3 { border-color: var(--lox3); color: var(--lox3) !important; }
        .lox4 { border-color: var(--lox4); color: var(--lox4) !important; }
        .lox5 { border-color: var(--lox5); color: var(--lox5) !important; }
        .lox6 { border-color: var(--lox6); color: var(--lox6) !important; }

        /* ORF and Functional Styling */
        .orf1 { background: var(--orf1); } .orf2 { background: var(--orf2); } 
        .orf3 { background: var(--orf3); } .orf4 { background: var(--orf4); }
        .stop { background: var(--stop); } 
        .pa { background: var(--pa); }
        .t2a { background: var(--t2a); border: 2px solid black; }

        .toolbox, .strand { display: flex; align-items: center; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .toolbox { background: #eee; gap: 2px; flex-wrap: wrap; }
        .strand { min-height: 110px; border: 2px dashed #ccc; gap: 2px; background: #fff; overflow-x: auto; }
        .strand.drag-over { background: #e3f2fd; border-color: #0072B2; }

        .delete-btn { 
            position: absolute; top: 0; right: 0; color: black; font-size: 16px; 
            cursor: pointer; font-weight: bold; display: none; z-index: 20; text-shadow: 0 0 2px white;
        }
        .piece-wrapper:hover .delete-btn { display: block; }

        .share-box { display: flex; gap: 10px; margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 8px; align-items: center;}
        input#sequence-string { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; }

        .summary-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .summary-table th, .summary-table td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        .summary-table th { background: #f4f4f4; }

        .outcome-box { border: 1px solid #ddd; padding: 10px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; border-radius: 6px; }
        .express-tag { padding: 4px 10px; border-radius: 4px; background: #333; color: #fff; font-weight: bold; font-size: 11px; white-space: nowrap;}
        button { cursor: pointer; padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; }
        .btn-primary { background: #2c3e50; color: #fff; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ§¬ Enhanced Construct Designer</h2>

    <div class="share-box">
        <strong>Code:</strong>
        <input type="text" id="sequence-string" placeholder="Paste code (e.g. Lox1,ORF1,Lox1r)">
        <button onclick="loadFromCode()">Load</button>
        <button onclick="updateCode()">Sync</button>
    </div>
    
    <div class="toolbox" id="toolbox">
        <div class="piece-wrapper" draggable="true" ondragstart="drag(event)" data-id="Lox1"><div class="dna-block lox-style lox1">Lox1</div></div>
        <div class="piece-wrapper" draggable="true" ondragstart="drag(event)" data-id="Lox2"><div class="dna-block lox-style lox2">Lox2</div></div>
        <div class="piece-wrapper" draggable="true" ondragstart="drag(event)" data-id="Lox3"><div class="dna-block lox-style lox3">Lox3</div></div>
        <div class="piece-wrapper" draggable="true" ondragstart="drag(event)" data-id="Lox4"><div class="dna-block lox-style lox4">Lox4</div></div>
        <div class="piece-wrapper" draggable="true" ondragstart="drag(event)" data-id="Lox5"><div class="dna-block lox-style lox5">Lox5</div></div>
        <div class="piece-wrapper" draggable="true" ondragstart="drag(event)" data-id="Lox6"><div class="dna-block lox-style lox6">Lox6</div></div>
        <div class="piece-wrapper" draggable="true" ondragstart="drag(event)" data-id="Stop"><div class="dna-block stop">Stop</div></div>
        <div class="piece-wrapper" draggable="true" ondragstart="drag(event)" data-id="pA"><div class="dna-block pa">polyA</div></div>
        <div class="piece-wrapper" draggable="true" ondragstart="drag(event)" data-id="T2A"><div class="dna-block t2a">T2A</div></div>
        <div class="piece-wrapper" draggable="true" ondragstart="drag(event)" data-id="ORF1"><div class="dna-block orf1">ORF1</div></div>
        <div class="piece-wrapper" draggable="true" ondragstart="drag(event)" data-id="ORF2"><div class="dna-block orf2">ORF2</div></div>
        <div class="piece-wrapper" draggable="true" ondragstart="drag(event)" data-id="ORF3"><div class="dna-block orf3">ORF3</div></div>
        <div class="piece-wrapper" draggable="true" ondragstart="drag(event)" data-id="ORF4"><div class="dna-block orf4">ORF4</div></div>
    </div>

    <div id="strand" class="strand" ondragover="allowDrop(event)" ondragleave="dragLeave(event)" ondrop="drop(event)"></div>

    <div style="display:flex; gap:10px;">
        <button class="btn-primary" onclick="runSimulation()">Simulate Cre-Recombination</button>
        <button onclick="clearStrand()" style="background:#ccc;">Clear</button>
    </div>

    <div id="summary-section"></div>
    <div id="results"></div>
</div>

<script>
    const strand = document.getElementById('strand');
    let draggedData = null;

    const lookup = {
        "Lox1": {type: "LOX", css: "lox-style lox1"}, "Lox2": {type: "LOX", css: "lox-style lox2"},
        "Lox3": {type: "LOX", css: "lox-style lox3"}, "Lox4": {type: "LOX", css: "lox-style lox4"},
        "Lox5": {type: "LOX", css: "lox-style lox5"}, "Lox6": {type: "LOX", css: "lox-style lox6"},
        "Stop": {type: "STOP", css: "stop"}, "pA": {type: "STOP", css: "pa"}, "T2A":  {type: "T2A",  css: "t2a"},
        "ORF1": {type: "ORF",  css: "orf1"}, "ORF2": {type: "ORF",  css: "orf2"},
        "ORF3": {type: "ORF",  css: "orf3"}, "ORF4": {type: "ORF",  css: "orf4"}
    };

    function allowDrop(ev) { ev.preventDefault(); strand.classList.add('drag-over'); }
    function dragLeave(ev) { strand.classList.remove('drag-over'); }
    
    function drag(ev) {
        const isFromStrand = ev.currentTarget.parentElement.id === 'strand';
        draggedData = { 
            id: ev.currentTarget.dataset.id, 
            isRev: ev.currentTarget.classList.contains('rev'),
            index: isFromStrand ? Array.from(strand.children).indexOf(ev.currentTarget) : -1
        };
    }
    
    function drop(ev) {
        ev.preventDefault();
        strand.classList.remove('drag-over');
        if (draggedData.index !== -1) {
            const pieces = [...strand.querySelectorAll('.piece-wrapper')];
            const target = pieces.find(s => ev.clientX < s.getBoundingClientRect().left + s.getBoundingClientRect().width/2);
            strand.insertBefore(pieces[draggedData.index], target || null);
        } else {
            addPiece(draggedData.id, false, ev.clientX);
        }
        updateCode();
    }

    function addPiece(id, isRev, mouseX) {
        const info = lookup[id];
        const wrapper = document.createElement('div');
        wrapper.className = `piece-wrapper placed ${isRev ? 'rev' : ''}`;
        wrapper.dataset.id = id;
        wrapper.draggable = true;
        wrapper.ondragstart = drag;
        wrapper.innerHTML = `<div class="dna-block ${info.css}">${id}</div><div class="delete-btn" onclick="this.parentElement.remove(); updateCode();">Ã—</div>`;
        wrapper.onclick = (e) => { 
            if(e.target.className === 'delete-btn') return; 
            wrapper.classList.toggle('rev'); 
            updateCode(); 
        };
        const siblings = [...strand.querySelectorAll('.piece-wrapper')];
        const next = siblings.find(s => mouseX < s.getBoundingClientRect().left + s.getBoundingClientRect().width/2);
        strand.insertBefore(wrapper, next || null);
        updateCode();
    }

    function updateCode() {
        document.getElementById('sequence-string').value = [...strand.querySelectorAll('.piece-wrapper')].map(el => {
            return el.dataset.id + (el.classList.contains('rev') ? 'r' : '');
        }).join(',');
    }

    function loadFromCode() {
        strand.innerHTML = '';
        const code = document.getElementById('sequence-string').value;
        if(!code) return;
        code.split(',').forEach(part => {
            const isRev = part.endsWith('r');
            const id = isRev ? part.slice(0, -1) : part;
            if(lookup[id]) addPiece(id, isRev, 99999);
        });
    }

    function clearStrand() { strand.innerHTML = ''; document.getElementById('sequence-string').value = ''; document.getElementById('results').innerHTML = ''; document.getElementById('summary-section').innerHTML = ''; }

    function getExpression(seq) {
        let expressed = [];
        for(let s of seq) {
            if(s.type === 'STOP' && s.dir === 1) break;
            if(s.type === 'ORF' && s.dir === 1) {
                expressed.push(s.id);
                let idx = seq.indexOf(s);
                if(!(seq[idx+1] && seq[idx+1].type === 'T2A')) break;
            }
        }
        return expressed.length > 0 ? expressed.join(' + ') : "None";
    }

    function runSimulation() {
        const initial = [...strand.querySelectorAll('.piece-wrapper')].map(p => ({ 
            ...lookup[p.dataset.id], id: p.dataset.id, dir: p.classList.contains('rev') ? -1 : 1 
        }));
        if(!initial.length) return;

        let visited = new Map();
        let queue = [{seq: initial, steps: 0}];
        visited.set(JSON.stringify(initial), 0);
        let outcomes = [];

        while(queue.length > 0 && outcomes.length < 100) {
            let {seq, steps} = queue.shift();
            outcomes.push({seq, steps, expr: getExpression(seq)});

            let loxIdx = seq.map((s, i) => s.type === 'LOX' ? i : -1).filter(i => i !== -1);
            for(let i=0; i < loxIdx.length; i++) {
                for(let j=i+1; j < loxIdx.length; j++) {
                    if(seq[loxIdx[i]].id !== seq[loxIdx[j]].id) continue;
                    let nextS = [];
                    if(seq[loxIdx[i]].dir !== seq[loxIdx[j]].dir) {
                        let mid = seq.slice(loxIdx[i]+1, loxIdx[j]).reverse().map(s => ({...s, dir: s.dir * -1}));
                        nextS = [...seq.slice(0, loxIdx[i]+1), ...mid, ...seq.slice(loxIdx[j])];
                    } else {
                        nextS = [...seq.slice(0, loxIdx[i]), seq[loxIdx[i]], ...seq.slice(loxIdx[j] + 1)];
                    }
                    if(!visited.has(JSON.stringify(nextS))) { visited.set(JSON.stringify(nextS), steps+1); queue.push({seq: nextS, steps: steps+1}); }
                }
            }
        }
        render(outcomes);
    }

    function render(outcomes) {
        const stats = {};
        outcomes.forEach(o => {
            if (!stats[o.expr]) stats[o.expr] = new Set();
            stats[o.expr].add(o.steps);
        });
        let summaryHtml = `<h3>Phenotype Summary</h3><table class="summary-table"><tr><th>Expressed Proteins</th><th>Steps (Paths)</th></tr>`;
        for (let key in stats) summaryHtml += `<tr><td><strong>${key}</strong></td><td>${Array.from(stats[key]).sort((a,b)=>a-b).join(', ')}</td></tr>`;
        document.getElementById('summary-section').innerHTML = summaryHtml + `</table>`;

        const res = document.getElementById('results');
        res.innerHTML = `<h3>Unique DNA States (${outcomes.length})</h3>`;
        outcomes.forEach(o => {
            const div = document.createElement('div');
            div.className = 'outcome-box';
            const dna = o.seq.map(s => `<div class="dna-block ${s.css}" style="transform: scale(0.6); min-width:70px; clip-path: polygon(${s.dir==1 ? '0% 0%, 85% 0%, 100% 50%, 85% 100%, 0% 100%' : '15% 0%, 100% 0%, 100% 100%, 15% 100%, 0% 50%'})">${s.id}${s.dir==-1?'r':''}</div>`).join('');
            div.innerHTML = `<div style="min-width:65px">Steps: ${o.steps}</div> <div style="display:flex; flex-grow:1; overflow-x:auto;">${dna}</div> <div class="express-tag">${o.expr}</div>`;
            res.appendChild(div);
        });
    }
</script>
</body>
</html>
